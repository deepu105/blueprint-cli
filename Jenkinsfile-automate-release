#!groovy

pipeline {
    agent none

    options {
        buildDiscarder(logRotator(numToKeepStr: '20', artifactDaysToKeepStr: '7', artifactNumToKeepStr: '5'))
        timeout(time: 1, unit: 'HOURS')
        timestamps()
        ansiColor('xterm')
    }

    parameters {
        choice(choices: ' \npatch\nminor\nmajor', description: 'Which version component should be incremented?', name: 'RELEASE_SCOPE')
        choice(choices: ' \nalpha\nbeta\nrc\nfinal', description: 'Which type of release do you want to do?', name: 'RELEASE_STAGE')
        string(defaultValue: '', description: 'Note: set scope and stage to \'blank\' to use this AND REMEMBER TO REMOVE THE EMPTY SPACE (Ascii code 20) THAT IS IN THIS FIELD INITIALLY!!!. In case of a new development cycle you may need to set the version number explicitly if it is non-contiguous. E.g. put something like 1.2.3 or 1.2.3-beta.10 here.', name: 'RELEASE_EXPLICIT')
    }

    stages {
        stage('Release and publish XL Cli') {
            agent {
                node {
                    label 'xld||xlr'
                }
            }

            tools {
                jdk 'JDK 8u171'
            }

            steps {
                checkout scm
                sh "./gradlew release -Drelease.releaseScope=${params.RELEASE_SCOPE} -Drelease.releaseStage=${params.RELEASE_STAGE} -Drelease.releaseExplicit=${params.RELEASE_EXPLICIT} -Prelease.disableChecks -Prelease.pushTagsOnly"
                sh "./gradlew clean build upx publish uploadToS3 -Poptimise --info"
            }
        }
    }
    post {
        success {
            script {
                if (env.BRANCH_NAME == 'master') {
                    hipchatSend color: 'GREEN', credentialId: 'hipchat-token', message: "XL Cli master release <b>SUCCESS</b> - <a href=\"${BUILD_URL}\">click to open</a>", notify: false, room: 'Developer ❤️'
                }
            }
        }
        failure {
            script {
                if (env.BRANCH_NAME == 'master') {
                    hipchatSend color: 'RED', credentialId: 'hipchat-token', message: "XL Cli master release <b>FAILED</b> - <a href=\"${BUILD_URL}\">click to open</a>", notify: true, room: 'Developer ❤️'
                }
            }
        }
    }
}
